<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HL Liquidation Hunter</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0b0b0f;
      --bg-secondary: #111118;
      --bg-card: #16161e;
      --bg-hover: #1c1c26;
      --border: #252530;
      --border-light: #32323f;
      --text-primary: #f0f0f5;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --green: #10b981;
      --green-dim: #059669;
      --red: #ef4444;
      --red-dim: #dc2626;
      --yellow: #f59e0b;
      --blue: #3b82f6;
      --purple: #8b5cf6;
      --cyan: #06b6d4;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }

    header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--red) 0%, var(--yellow) 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .logo h1 {
      font-size: 1rem;
      font-weight: 600;
    }

    .logo span {
      color: var(--text-muted);
      font-size: 0.75rem;
      font-weight: 400;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
    }

    .btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }

    .btn:hover {
      background: var(--bg-hover);
      border-color: var(--border-light);
      color: var(--text-primary);
    }

    .btn-primary {
      background: var(--blue);
      border-color: var(--blue);
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    main {
      padding: 1.5rem;
      max-width: 1800px;
      margin: 0 auto;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    @media (max-width: 900px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem 1.25rem;
    }

    .stat-card.danger { border-left: 3px solid var(--red); }
    .stat-card.warning { border-left: 3px solid var(--yellow); }

    .stat-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    .stat-value.red { color: var(--red); }
    .stat-value.yellow { color: var(--yellow); }

    .filters-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      align-items: center;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-group label {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .filter-select {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      font-size: 0.8rem;
      font-family: inherit;
      cursor: pointer;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--blue);
    }

    .grid-layout {
      display: grid;
      grid-template-columns: 1fr 1fr 340px;
      gap: 1rem;
      align-items: start;
    }

    @media (max-width: 1400px) {
      .grid-layout { grid-template-columns: 1fr 1fr; }
      .liq-panel { grid-column: span 2; }
    }

    @media (max-width: 900px) {
      .grid-layout { grid-template-columns: 1fr; }
      .liq-panel { grid-column: span 1; }
    }

    .position-column {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .column-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .column-header.long { border-top: 3px solid var(--green); }
    .column-header.short { border-top: 3px solid var(--red); }

    .column-title {
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .column-title.long { color: var(--green); }
    .column-title.short { color: var(--red); }

    .column-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    .column-meta strong { color: var(--text-secondary); }

    .pos-card {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    .pos-card:hover { background: var(--bg-hover); }
    .pos-card:last-child { border-bottom: none; }
    .pos-card.critical { background: rgba(239, 68, 68, 0.05); }

    .pos-row-1 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .pos-address {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .pos-address a {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      color: var(--cyan);
      text-decoration: none;
    }

    .pos-address a:hover { text-decoration: underline; }

    .badge {
      font-size: 0.6rem;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-new { background: var(--cyan); color: var(--bg-primary); }
    .badge-profitable { background: rgba(16, 185, 129, 0.15); color: var(--green); border: 1px solid rgba(16, 185, 129, 0.3); }
    .badge-losing { background: rgba(239, 68, 68, 0.15); color: var(--red); border: 1px solid rgba(239, 68, 68, 0.3); }
    .badge-critical { background: var(--red); color: white; }
    .badge-warning { background: var(--yellow); color: var(--bg-primary); }

    .pos-alltime {
      font-size: 0.75rem;
      padding: 0.4rem 0.6rem;
      background: var(--bg-secondary);
      border-radius: 4px;
      margin-bottom: 0.75rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .pos-alltime-label { color: var(--text-muted); }
    .pos-alltime-value { font-weight: 600; font-family: 'JetBrains Mono', monospace; }
    .pos-alltime-value.positive { color: var(--green); }
    .pos-alltime-value.negative { color: var(--red); }

    .pos-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .pos-field {
      background: var(--bg-secondary);
      padding: 0.5rem;
      border-radius: 4px;
      text-align: center;
    }

    .pos-field-label {
      font-size: 0.6rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .pos-field-value {
      font-size: 0.85rem;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
      margin-top: 0.15rem;
    }

    .pos-field-value.red { color: var(--red); }
    .pos-field-value.yellow { color: var(--yellow); }
    .pos-field-value.green { color: var(--green); }
    .pos-field-value.purple { color: var(--purple); }

    .pos-prices {
      display: flex;
      gap: 1rem;
      font-size: 0.7rem;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    .pos-prices b { color: var(--text-secondary); }
    .pos-prices .liq { color: var(--red); }

    .other-pos-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 0.7rem;
      cursor: pointer;
      padding: 0.25rem 0;
      margin-top: 0.5rem;
      font-family: inherit;
    }

    .other-pos-btn:hover { color: var(--text-secondary); }

    .other-pos-list {
      display: none;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px dashed var(--border);
    }

    .other-pos-list.show { display: block; }

    .other-pos-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.35rem 0;
      font-size: 0.7rem;
    }

    .other-pos-item span { font-family: 'JetBrains Mono', monospace; }

    .empty-state {
      padding: 2rem;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .liq-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      position: sticky;
      top: 70px;
    }

    .liq-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .liq-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      border-bottom: 1px solid var(--border);
    }

    .liq-stat {
      padding: 0.75rem;
      text-align: center;
    }

    .liq-stat:first-child { border-right: 1px solid var(--border); }

    .liq-stat-label {
      font-size: 0.6rem;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.05em;
    }

    .liq-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      margin-top: 0.15rem;
    }

    .liq-stat-value.green { color: var(--green); }
    .liq-stat-value.red { color: var(--red); }

    .liq-filters {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 0.35rem;
    }

    .liq-filter-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.65rem;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }

    .liq-filter-btn:hover, .liq-filter-btn.active {
      background: var(--blue);
      border-color: var(--blue);
      color: white;
    }

    .liq-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .liq-item {
      display: flex;
      align-items: center;
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--border);
      gap: 0.5rem;
    }

    .liq-item:last-child { border-bottom: none; }

    .liq-side {
      width: 3px;
      height: 28px;
      border-radius: 2px;
    }

    .liq-side.long { background: var(--green); }
    .liq-side.short { background: var(--red); }

    .liq-info { flex: 1; }

    .liq-coin {
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    .liq-badge {
      font-size: 0.5rem;
      padding: 0.1rem 0.25rem;
      border-radius: 2px;
      font-weight: 600;
    }

    .liq-badge.long { background: rgba(16, 185, 129, 0.2); color: var(--green); }
    .liq-badge.short { background: rgba(239, 68, 68, 0.2); color: var(--red); }

    .liq-price {
      font-size: 0.65rem;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    .liq-value { text-align: right; }

    .liq-amount {
      font-size: 0.8rem;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
    }

    .liq-time {
      font-size: 0.6rem;
      color: var(--text-muted);
    }

    .whale-section {
      border-top: 2px solid var(--purple);
      background: rgba(139, 92, 246, 0.03);
    }

    .whale-header {
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--purple);
      display: flex;
      align-items: center;
      gap: 0.35rem;
      border-bottom: 1px solid var(--border);
    }

    .whale-list {
      max-height: 180px;
      overflow-y: auto;
    }

    .whale-list .liq-amount { color: var(--purple); }

    .toast-container {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .toast {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-left: 3px solid var(--red);
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-size: 0.8rem;
      animation: slideIn 0.3s ease;
      max-width: 320px;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.show { display: flex; }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.5rem;
      width: 90%;
      max-width: 400px;
    }

    .modal h3 {
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .modal input {
      width: 100%;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.75rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-family: 'JetBrains Mono', monospace;
      margin-bottom: 1rem;
    }

    .modal input:focus {
      outline: none;
      border-color: var(--blue);
    }

    .modal-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-icon">‚ö°</div>
      <div>
        <h1>HL Liquidation Hunter</h1>
        <span>Real-time high-risk position tracker</span>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn" onclick="openModal()">+ Add Address</button>
      <button class="btn btn-primary" onclick="refreshData()">‚Üª Refresh</button>
    </div>
  </header>

  <main>
    <div class="stats-row">
      <div class="stat-card danger">
        <div class="stat-label">Critical (&lt;5%)</div>
        <div class="stat-value red" id="criticalCount">0</div>
      </div>
      <div class="stat-card warning">
        <div class="stat-label">Warning (5-10%)</div>
        <div class="stat-value yellow" id="warningCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Value at Risk</div>
        <div class="stat-value" id="totalValue">$0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Positions Tracked</div>
        <div class="stat-value" id="totalPositions">0</div>
      </div>
    </div>

    <div class="filters-bar">
      <div class="filter-group">
        <label>Min Size</label>
        <select class="filter-select" id="minSizeFilter">
          <option value="2000000">$2M+</option>
          <option value="5000000">$5M+</option>
          <option value="10000000">$10M+</option>
          <option value="20000000">$20M+</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Max Distance</label>
        <select class="filter-select" id="maxDistanceFilter">
          <option value="10">10%</option>
          <option value="5">5%</option>
          <option value="3">3%</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Level</label>
        <select class="filter-select" id="dangerFilter">
          <option value="">All</option>
          <option value="CRITICAL">Critical</option>
          <option value="WARNING">Warning</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Coin</label>
        <select class="filter-select" id="coinFilter">
          <option value="">All</option>
        </select>
      </div>
    </div>

    <div class="grid-layout">
      <div class="position-column">
        <div class="column-header long">
          <div class="column-title long">üü¢ Longs at Risk</div>
          <div class="column-meta"><strong id="longsTotal">$0</strong> ¬∑ <span id="longsCount">0</span> positions</div>
        </div>
        <div id="longsList"><div class="empty-state">No longs at risk</div></div>
      </div>

      <div class="position-column">
        <div class="column-header short">
          <div class="column-title short">üî¥ Shorts at Risk</div>
          <div class="column-meta"><strong id="shortsTotal">$0</strong> ¬∑ <span id="shortsCount">0</span> positions</div>
        </div>
        <div id="shortsList"><div class="empty-state">No shorts at risk</div></div>
      </div>

      <div class="liq-panel">
        <div class="liq-header">üíÄ Recent Liquidations</div>
        <div class="liq-stats">
          <div class="liq-stat">
            <div class="liq-stat-label">Longs Liq'd</div>
            <div class="liq-stat-value green" id="liqLongValue">$0</div>
          </div>
          <div class="liq-stat">
            <div class="liq-stat-label">Shorts Liq'd</div>
            <div class="liq-stat-value red" id="liqShortValue">$0</div>
          </div>
        </div>
        <div class="liq-filters">
          <button class="liq-filter-btn active" data-filter="all">All</button>
          <button class="liq-filter-btn" data-filter="50000">$50K+</button>
          <button class="liq-filter-btn" data-filter="100000">$100K+</button>
          <button class="liq-filter-btn" data-filter="250000">$250K+</button>
        </div>
        <div class="liq-list" id="liqList"><div class="empty-state">Waiting for liquidations...</div></div>
        <div class="whale-section">
          <div class="whale-header">üêã Whale Liquidations ($500K+)</div>
          <div class="whale-list" id="whaleLiqList"><div class="empty-state">No whale liquidations yet</div></div>
        </div>
      </div>
    </div>
  </main>

  <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>Add Address to Track</h3>
      <input type="text" id="addressInput" placeholder="0x..." />
      <div class="modal-actions">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitAddress()">Add</button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    const API_BASE = '';
    let currentLiqFilter = 'all';
    let previousPositions = new Map();

    function formatUSD(value) {
      const num = Math.abs(value);
      if (num >= 1000000) return '$' + (num / 1000000).toFixed(2) + 'M';
      if (num >= 1000) return '$' + (num / 1000).toFixed(1) + 'K';
      return '$' + num.toFixed(0);
    }

    function formatPrice(price) {
      if (!price) return '-';
      if (price >= 10000) return price.toFixed(0);
      if (price >= 100) return price.toFixed(1);
      if (price >= 1) return price.toFixed(2);
      return price.toFixed(4);
    }

    function timeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return seconds + 's';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return minutes + 'm';
      return Math.floor(minutes / 60) + 'h';
    }

    function showToast(message) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    function openModal() {
      document.getElementById('modalOverlay').classList.add('show');
      document.getElementById('addressInput').focus();
    }

    function closeModal(e) {
      if (!e || e.target === document.getElementById('modalOverlay')) {
        document.getElementById('modalOverlay').classList.remove('show');
        document.getElementById('addressInput').value = '';
      }
    }

    async function submitAddress() {
      const address = document.getElementById('addressInput').value.trim();
      if (!address || !address.startsWith('0x')) {
        showToast('Invalid address format');
        return;
      }
      try {
        await fetch(`${API_BASE}/api/add-address`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address })
        });
        showToast('Address added');
        closeModal();
        refreshData();
      } catch (err) {
        showToast('Failed to add address');
      }
    }

    async function fetchPositions() {
      const params = new URLSearchParams({
        minSize: document.getElementById('minSizeFilter').value,
        maxDistance: document.getElementById('maxDistanceFilter').value,
        dangerLevel: document.getElementById('dangerFilter').value
      });
      const res = await fetch(`${API_BASE}/api/positions?${params}`);
      return await res.json();
    }

    async function fetchStats() {
      const res = await fetch(`${API_BASE}/api/stats`);
      return await res.json();
    }

    async function fetchLiquidations() {
      const minValue = currentLiqFilter === 'all' ? 0 : parseInt(currentLiqFilter);
      const res = await fetch(`${API_BASE}/api/liquidations?minValue=${minValue}&limit=30`);
      return await res.json();
    }

    async function fetchWhaleLiquidations() {
      const res = await fetch(`${API_BASE}/api/whale-liquidations?limit=10`);
      return await res.json();
    }

    function renderPositionCard(pos, idx) {
      const isProfitable = pos.isProfitableWhale;
      const allTimePnl = pos.allTimePnl;
      let pnlDisplay = 'N/A';
      let pnlClass = '';
      
      if (allTimePnl !== null && allTimePnl !== undefined) {
        pnlDisplay = (allTimePnl >= 0 ? '+' : '') + formatUSD(allTimePnl);
        pnlClass = allTimePnl >= 0 ? 'positive' : 'negative';
      }

      return `
        <div class="pos-card ${pos.dangerLevel === 'CRITICAL' ? 'critical' : ''}">
          <div class="pos-row-1">
            <div class="pos-address">
              <a href="${pos.hyperliquidUrl}" target="_blank">${pos.userShort}</a>
              ${pos.isNewAddress ? '<span class="badge badge-new">NEW</span>' : ''}
              <span class="badge ${isProfitable ? 'badge-profitable' : 'badge-losing'}">${isProfitable ? 'üí∞ Profitable' : 'üé∞ Losing'}</span>
            </div>
            <span class="badge badge-${pos.dangerLevel.toLowerCase()}">${pos.dangerLevel}</span>
          </div>
          <div class="pos-alltime">
            <span class="pos-alltime-label">All-Time PnL</span>
            <span class="pos-alltime-value ${pnlClass}">${pnlDisplay}</span>
          </div>
          <div class="pos-grid">
            <div class="pos-field">
              <div class="pos-field-label">Coin</div>
              <div class="pos-field-value">${pos.coin}</div>
            </div>
            <div class="pos-field">
              <div class="pos-field-label">Size</div>
              <div class="pos-field-value">${formatUSD(pos.positionUSD)}</div>
            </div>
            <div class="pos-field">
              <div class="pos-field-label">Distance</div>
              <div class="pos-field-value ${pos.dangerLevel === 'CRITICAL' ? 'red' : 'yellow'}">${pos.distancePercent}%</div>
            </div>
            <div class="pos-field">
              <div class="pos-field-label">Leverage</div>
              <div class="pos-field-value purple">${pos.leverage}x</div>
            </div>
            <div class="pos-field">
              <div class="pos-field-label">This PnL</div>
              <div class="pos-field-value ${pos.unrealizedPnl >= 0 ? 'green' : 'red'}">${pos.unrealizedPnl >= 0 ? '+' : ''}${formatUSD(pos.unrealizedPnl)}</div>
            </div>
            <div class="pos-field">
              <div class="pos-field-label">Wallet</div>
              <div class="pos-field-value">${pos.walletBalance ? formatUSD(pos.walletBalance) : '-'}</div>
            </div>
          </div>
          <div class="pos-prices">
            <span>Entry: <b>${formatPrice(pos.entryPrice)}</b></span>
            <span>Mark: <b>${formatPrice(pos.markPrice)}</b></span>
            <span class="liq">Liq: <b>${formatPrice(pos.liqPrice)}</b></span>
          </div>
          ${pos.otherPositions && pos.otherPositions.length > 0 ? `
            <button class="other-pos-btn" onclick="toggleOther(${idx})">
              ${pos.otherPositions.length} other position${pos.otherPositions.length > 1 ? 's' : ''} ‚ñº
            </button>
            <div class="other-pos-list" id="other-${idx}">
              ${pos.otherPositions.map(op => `
                <div class="other-pos-item">
                  <span>${op.coin} <span class="badge ${op.direction === 'LONG' ? 'badge-profitable' : 'badge-losing'}" style="font-size:0.5rem">${op.direction}</span></span>
                  <span>${formatUSD(op.positionUSD)}</span>
                  <span style="color:${op.unrealizedPnl >= 0 ? 'var(--green)' : 'var(--red)'}">${op.unrealizedPnl >= 0 ? '+' : ''}${formatUSD(op.unrealizedPnl)}</span>
                </div>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;
    }

    function toggleOther(idx) {
      document.getElementById('other-' + idx)?.classList.toggle('show');
    }

    function renderPositions(data) {
      const coinFilter = document.getElementById('coinFilter').value;
      let longs = data.longs || [];
      let shorts = data.shorts || [];

      if (coinFilter) {
        longs = longs.filter(p => p.coin === coinFilter);
        shorts = shorts.filter(p => p.coin === coinFilter);
      }

      document.getElementById('longsTotal').textContent = formatUSD(data.longsAtRisk || 0);
      document.getElementById('shortsTotal').textContent = formatUSD(data.shortsAtRisk || 0);
      document.getElementById('longsCount').textContent = longs.length;
      document.getElementById('shortsCount').textContent = shorts.length;

      document.getElementById('longsList').innerHTML = longs.length
        ? longs.map((p, i) => renderPositionCard(p, i)).join('')
        : '<div class="empty-state">No longs at risk</div>';

      document.getElementById('shortsList').innerHTML = shorts.length
        ? shorts.map((p, i) => renderPositionCard(p, i + 1000)).join('')
        : '<div class="empty-state">No shorts at risk</div>';

      [...longs, ...shorts].forEach(pos => {
        const key = `${pos.user}-${pos.coin}`;
        if (!previousPositions.has(key) && pos.dangerLevel === 'CRITICAL') {
          showToast(`üö® New CRITICAL: ${pos.coin} ${pos.direction} @ ${pos.distancePercent}%`);
        }
        previousPositions.set(key, pos);
      });
    }

    function renderLiquidations(data) {
      document.getElementById('liqLongValue').textContent = formatUSD(data.longValue || 0);
      document.getElementById('liqShortValue').textContent = formatUSD(data.shortValue || 0);

      const list = document.getElementById('liqList');
      if (!data.liquidations || data.liquidations.length === 0) {
        list.innerHTML = '<div class="empty-state">Waiting for liquidations...</div>';
        return;
      }

      list.innerHTML = data.liquidations.map(liq => `
        <div class="liq-item">
          <div class="liq-side ${liq.side.toLowerCase()}"></div>
          <div class="liq-info">
            <div class="liq-coin">${liq.coin} <span class="liq-badge ${liq.side.toLowerCase()}">${liq.side}</span></div>
            <div class="liq-price">@ $${formatPrice(liq.price)}</div>
          </div>
          <div class="liq-value">
            <div class="liq-amount">${formatUSD(liq.value)}</div>
            <div class="liq-time">${timeAgo(liq.timestamp)} ago</div>
          </div>
        </div>
      `).join('');
    }

    function renderWhaleLiquidations(data) {
      const list = document.getElementById('whaleLiqList');
      if (!data.liquidations || data.liquidations.length === 0) {
        list.innerHTML = '<div class="empty-state">No whale liquidations yet</div>';
        return;
      }

      list.innerHTML = data.liquidations.map(liq => `
        <div class="liq-item">
          <div class="liq-side ${liq.side.toLowerCase()}"></div>
          <div class="liq-info">
            <div class="liq-coin">${liq.coin} <span class="liq-badge ${liq.side.toLowerCase()}">${liq.side}</span></div>
            <div class="liq-price">@ $${formatPrice(liq.price)}</div>
          </div>
          <div class="liq-value">
            <div class="liq-amount">${formatUSD(liq.value)}</div>
            <div class="liq-time">${timeAgo(liq.timestamp)} ago</div>
          </div>
        </div>
      `).join('');
    }

    async function refreshData() {
      try {
        const [positions, stats] = await Promise.all([fetchPositions(), fetchStats()]);
        
        document.getElementById('criticalCount').textContent = stats.criticalCount || 0;
        document.getElementById('warningCount').textContent = stats.warningCount || 0;
        document.getElementById('totalValue').textContent = formatUSD(stats.totalValueAtRisk || 0);
        document.getElementById('totalPositions').textContent = positions.count || 0;

        renderPositions(positions);

        if (stats.byCoin) {
          const coinSelect = document.getElementById('coinFilter');
          const currentVal = coinSelect.value;
          const coins = Object.keys(stats.byCoin).sort();
          coinSelect.innerHTML = '<option value="">All</option>' + coins.map(c => `<option value="${c}">${c}</option>`).join('');
          coinSelect.value = currentVal;
        }
      } catch (err) {
        console.error('Refresh error:', err);
      }
    }

    async function refreshLiquidations() {
      try {
        const [liqData, whaleData] = await Promise.all([fetchLiquidations(), fetchWhaleLiquidations()]);
        renderLiquidations(liqData);
        renderWhaleLiquidations(whaleData);
      } catch (err) {
        console.error('Liq refresh error:', err);
      }
    }

    document.querySelectorAll('.filter-select').forEach(el => {
      el.addEventListener('change', refreshData);
    });

    document.querySelectorAll('.liq-filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.liq-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentLiqFilter = btn.dataset.filter;
        refreshLiquidations();
      });
    });

    refreshData();
    refreshLiquidations();
    setInterval(refreshData, 30000);
    setInterval(refreshLiquidations, 5000);
  </script>
</body>
</html>
